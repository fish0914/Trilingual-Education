<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰èªè¨ˆç•«æˆæœå±• (ç³»çµ±é™¤éŒ¯ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen flex flex-col pb-64">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40 border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg text-white">
                    <i data-lucide="school" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-900 tracking-tight">ä¸‰èªè¨ˆç•«æˆæœå±•</h1>
                    <p class="text-xs text-slate-500 font-medium">SDGsç§‘æŠ€å‰µä½œ x è³‡è¨Šå°ˆé¡Œ</p>
                </div>
            </div>
            
            <nav class="flex space-x-1 bg-slate-100 p-1 rounded-lg">
                <button onclick="switchTab('gallery')" id="btn-tab-gallery" class="px-4 py-2 text-sm font-medium rounded-md transition-all bg-white text-blue-600 shadow-sm flex items-center gap-2">
                    <i data-lucide="layout" class="w-4 h-4"></i> æˆæœå±•ç¤º
                </button>
                <button onclick="switchTab('admin')" id="btn-tab-admin" class="px-4 py-2 text-sm font-medium rounded-md transition-all text-slate-600 hover:text-slate-900 flex items-center gap-2">
                    <i data-lucide="upload" class="w-4 h-4"></i> è³‡æ–™ä¸Šå‚³
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-1 w-full">
        
        <!-- Filter Buttons -->
        <div id="filter-container" class="mb-8 flex justify-center transition-all duration-300">
            <div class="inline-flex rounded-md shadow-sm" role="group">
                <button type="button" onclick="setFilter('sdgs')" id="btn-filter-sdgs" class="px-6 py-3 text-sm font-medium border rounded-l-lg focus:z-10 focus:ring-2 transition-colors bg-blue-600 text-white border-blue-600">
                    ğŸŒ± SDGs ç§‘æŠ€å‰µä½œèª²
                </button>
                <button type="button" onclick="setFilter('info')" id="btn-filter-info" class="px-6 py-3 text-sm font-medium border rounded-r-lg focus:z-10 focus:ring-2 transition-colors bg-white text-slate-700 border-slate-300 hover:bg-slate-50">
                    ğŸ’» è³‡è¨Šå°ˆé¡Œèª²
                </button>
            </div>
        </div>

        <!-- Gallery View -->
        <div id="view-gallery" class="block">
            <div id="gallery-loader" class="flex flex-col items-center justify-center h-64 text-slate-400">
                <i data-lucide="loader-2" class="animate-spin w-8 h-8 text-blue-600 mb-4"></i>
                <p>æ­£åœ¨é€£ç·šè‡³è³‡æ–™åº«è®€å–è³‡æ–™...</p>
            </div>
            
            <div id="gallery-error" class="hidden text-center py-10">
                <div class="inline-block p-6 bg-red-50 text-red-700 rounded-xl border border-red-200 max-w-lg shadow-sm">
                    <div class="flex flex-col items-center gap-3">
                        <div class="bg-red-100 p-3 rounded-full">
                            <i data-lucide="shield-alert" class="w-8 h-8 text-red-600"></i>
                        </div>
                        <h3 class="font-bold text-lg">è®€å–è³‡æ–™ç™¼ç”ŸéŒ¯èª¤</h3>
                        <p id="gallery-error-msg" class="text-sm text-red-600 leading-relaxed font-mono text-left"></p>
                    </div>
                </div>
            </div>
            
            <div id="gallery-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                <!-- Project cards injected here -->
            </div>
            <div id="gallery-empty" class="hidden text-center py-20 bg-white rounded-2xl border-2 border-dashed border-slate-200">
                <i data-lucide="school" class="mx-auto h-12 w-12 text-slate-300"></i>
                <h3 class="mt-2 text-sm font-semibold text-slate-900">è³‡æ–™åº«è®€å–æˆåŠŸï¼Œä½†ç›®å‰æ²’æœ‰è³‡æ–™</h3>
                <p class="mt-1 text-sm text-slate-500">è«‹å˜—è©¦é‡æ–°ä¸Šå‚³ä¸€ç­†è³‡æ–™çœ‹çœ‹ã€‚</p>
            </div>
        </div>

        <!-- Admin View -->
        <div id="view-admin" class="hidden">
            <!-- Login State -->
            <div id="admin-login" class="flex flex-col items-center justify-center py-20 bg-white rounded-xl shadow-sm border border-slate-200 max-w-md mx-auto">
                <div class="bg-slate-100 p-4 rounded-full mb-4">
                    <i data-lucide="lock" class="w-10 h-10 text-slate-400"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">ç®¡ç†å“¡æ¬Šé™é–å®š</h3>
                <p class="text-slate-500 mb-6 text-sm">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥é€²è¡Œè³‡æ–™ä¸Šå‚³æˆ–åˆªé™¤ã€‚</p>
                <form onsubmit="handleAdminLogin(event)" class="flex gap-2 w-full px-8">
                    <input type="password" id="admin-password" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="è¼¸å…¥å¯†ç¢¼..." autofocus>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 text-sm">è§£é–</button>
                </form>
            </div>

            <!-- Dashboard State -->
            <div id="admin-dashboard" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Form -->
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 sticky top-24">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                                <i data-lucide="plus" class="text-blue-600 w-5 h-5"></i>
                                æ–°å¢ä½œå“
                            </h3>
                            <button onclick="handleAdminLogout()" class="text-xs text-slate-400 hover:text-slate-600 flex items-center gap-1">
                                <i data-lucide="log-out" class="w-3 h-3"></i> ç™»å‡º
                            </button>
                        </div>
                        
                        <form onsubmit="handleUpload(event)" class="space-y-4">
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <label class="block text-sm font-medium text-slate-700 mb-2">é¸æ“‡èª²ç¨‹åˆ†é¡ *</label>
                                <div class="flex gap-2">
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="courseType" value="sdgs" checked class="peer sr-only">
                                        <div class="text-center py-2 px-3 rounded-md border border-slate-300 bg-white text-slate-600 text-sm peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 transition-all">
                                            SDGs å‰µä½œ
                                        </div>
                                    </label>
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="courseType" value="info" class="peer sr-only">
                                        <div class="text-center py-2 px-3 rounded-md border border-slate-300 bg-white text-slate-600 text-sm peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 transition-all">
                                            è³‡è¨Šå°ˆé¡Œ
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">ä½œå“æ¨™é¡Œ *</label>
                                <input required type="text" id="input-title" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚ï¼šæ™ºæ…§åƒåœ¾æ¡¶è¨­è¨ˆ">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">å­¸ç”Ÿå§“å/çµ„å“¡ *</label>
                                <input required type="text" id="input-student" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜ã€æå°è¯">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">ä½œå“ç°¡ä»‹</label>
                                <textarea rows="3" id="input-desc" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="è«‹ç°¡è¿°å‰µä½œç†å¿µ..."></textarea>
                            </div>

                            <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 space-y-4">
                                <p class="text-xs text-slate-500 font-bold uppercase tracking-wider">è³‡æºè¨­å®š</p>
                                
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1 flex items-center gap-1">
                                        <i data-lucide="youtube" class="w-3 h-3"></i> å½±ç‰‡é€£çµ
                                    </label>
                                    <input type="text" id="input-video" oninput="updatePreview()" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-1 focus:ring-blue-500 font-mono" placeholder="è²¼ä¸Š YouTube ç¶²å€ æˆ– <iframe...> åŸå§‹ç¢¼">
                                    <div id="video-preview-container" class="mt-3 bg-black rounded-lg overflow-hidden aspect-video relative hidden">
                                        <iframe id="video-preview-frame" class="w-full h-full" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin"></iframe>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-2 flex items-center gap-1">
                                        <i data-lucide="file-text" class="w-3 h-3"></i> ç°¡å ±é€£çµ
                                    </label>
                                    <input type="url" id="input-slides" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-1 focus:ring-blue-500" placeholder="Google Slides / Canva é€£çµ">
                                </div>
                            </div>

                            <button type="submit" id="btn-submit" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-medium hover:bg-blue-700 transition-colors flex justify-center items-center gap-2">
                                <i data-lucide="check-circle-2" class="w-4 h-4"></i> ç¢ºèªç™¼å¸ƒ
                            </button>
                        </form>
                    </div>
                </div>

                <!-- List -->
                <div class="lg:col-span-2">
                    <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                        <i data-lucide="unlock" class="text-emerald-600 w-4 h-4"></i>
                        ç®¡ç†å“¡æ¨¡å¼ï¼šå·²ä¸Šå‚³ä½œå“ (é¡¯ç¤ºå…¨éƒ¨)
                    </h3>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <ul id="admin-list" class="divide-y divide-slate-100">
                            <!-- List items injected here -->
                        </ul>
                        <div id="admin-empty" class="p-8 text-center text-slate-500 hidden">ç›®å‰è³‡æ–™åº«ä¸­æ²’æœ‰ä»»ä½•è³‡æ–™</div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- DEBUG CONSOLE (Diagnostic Tool) -->
    <div class="fixed bottom-0 left-0 w-full h-48 bg-slate-900 text-green-400 font-mono text-xs overflow-y-auto p-4 z-[9999] border-t-4 border-slate-700 shadow-2xl opacity-95">
        <div class="flex justify-between items-center mb-2 sticky top-0 bg-slate-900 pb-2 border-b border-slate-800">
            <span class="font-bold text-white flex items-center gap-2"><i data-lucide="terminal" class="w-3 h-3"></i> ç³»çµ±è¨ºæ–·æ—¥èªŒ (System Diagnostics)</span>
            <button onclick="document.getElementById('debug-log').innerHTML=''" class="px-2 py-1 bg-slate-800 text-slate-300 rounded hover:bg-slate-700">æ¸…é™¤æ—¥èªŒ</button>
        </div>
        <div id="debug-log" class="space-y-1"></div>
    </div>

    <!-- Modal -->
    <div id="modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden flex flex-col h-[90vh] scale-95 transition-transform duration-300" id="modal-content">
            <div class="p-4 border-b border-slate-100 flex items-center justify-between bg-white sticky top-0 z-10">
                <div>
                    <h2 id="modal-title" class="text-lg font-bold text-slate-900 flex items-center gap-2"></h2>
                    <p id="modal-author" class="text-sm text-slate-500"></p>
                </div>
                <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-500 hover:text-slate-900">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="modal-body" class="flex-1 bg-slate-100 relative w-full overflow-hidden flex flex-col"></div>
            <div id="modal-desc" class="p-4 bg-slate-50 text-sm text-slate-600 border-t border-slate-200 shrink-0"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config (User Provided) ---
        const manualFirebaseConfig = {
            apiKey: "AIzaSyAHTx94zX8cXxf9hBtHRQ_CmNqFvFBWYeQ",
            authDomain: "trilingual-85fe6.firebaseapp.com",
            projectId: "trilingual-85fe6",
            storageBucket: "trilingual-85fe6.firebasestorage.app",
            messagingSenderId: "939793055372",
            appId: "1:939793055372:web:aaac421113763b65d885a9",
            measurementId: "G-NTLTR45WS6"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'school-project-default';
        const ADMIN_PASSWORD = "mdjhmdjh";
        
        let db = null;
        let auth = null;
        let currentUser = null;
        let currentProjects = [];
        let currentFilter = 'sdgs';
        let isAdminLoggedIn = false;

        // --- Logger ---
        function log(msg, type = 'info') {
            const box = document.getElementById('debug-log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-emerald-400' : 'text-slate-300');
            const icon = type === 'error' ? 'âŒ' : (type === 'success' ? 'âœ…' : 'â„¹ï¸');
            box.innerHTML += `<div class="${color}">[${time}] ${icon} ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        // --- Helper Functions ---
        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        window.getEmbedUrl = (inputString) => {
            if (!inputString) return '';
            let cleanUrl = inputString.trim();
            if (cleanUrl.includes('<iframe')) {
                const srcMatch = cleanUrl.match(/src\s*=\s*["']([^"']+)["']/);
                if (srcMatch && srcMatch[1]) cleanUrl = srcMatch[1];
            }
            try {
                const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=|live\/|shorts\/)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = cleanUrl.match(youtubeRegex);
                if (match && match[1]) return `https://www.youtube.com/embed/${match[1]}?rel=0&modestbranding=1&playsinline=1`;
                if (cleanUrl.includes('drive.google.com')) return cleanUrl.replace(/\/view.*$/, '/preview').replace(/\/edit.*$/, '/preview');
                if (cleanUrl.includes('vimeo.com')) {
                    const parts = cleanUrl.split('/');
                    const possibleId = parts[parts.length-1].split('?')[0];
                    if (!isNaN(possibleId)) return `https://player.vimeo.com/video/${possibleId}`;
                }
                return cleanUrl;
            } catch (e) { return ''; }
        };

        // --- UI Logic ---
        window.switchTab = (tab) => {
            const btnGallery = document.getElementById('btn-tab-gallery');
            const btnAdmin = document.getElementById('btn-tab-admin');
            const filterContainer = document.getElementById('filter-container');
            if (tab === 'gallery') {
                btnGallery.className = "px-4 py-2 text-sm font-medium rounded-md transition-all bg-white text-blue-600 shadow-sm flex items-center gap-2";
                btnAdmin.className = "px-4 py-2 text-sm font-medium rounded-md transition-all text-slate-600 hover:text-slate-900 flex items-center gap-2";
                document.getElementById('view-gallery').classList.remove('hidden');
                document.getElementById('view-admin').classList.add('hidden');
                filterContainer.classList.remove('hidden');
            } else {
                btnGallery.className = "px-4 py-2 text-sm font-medium rounded-md transition-all text-slate-600 hover:text-slate-900 flex items-center gap-2";
                btnAdmin.className = "px-4 py-2 text-sm font-medium rounded-md transition-all bg-white text-blue-600 shadow-sm flex items-center gap-2";
                document.getElementById('view-gallery').classList.add('hidden');
                document.getElementById('view-admin').classList.remove('hidden');
                filterContainer.classList.add('hidden');
            }
            renderApp();
        };

        window.setFilter = (filter) => {
            currentFilter = filter;
            const btnSdgs = document.getElementById('btn-filter-sdgs');
            const btnInfo = document.getElementById('btn-filter-info');
            if (filter === 'sdgs') {
                btnSdgs.className = "px-6 py-3 text-sm font-medium border rounded-l-lg focus:z-10 focus:ring-2 transition-colors bg-blue-600 text-white border-blue-600";
                btnInfo.className = "px-6 py-3 text-sm font-medium border rounded-r-lg focus:z-10 focus:ring-2 transition-colors bg-white text-slate-700 border-slate-300 hover:bg-slate-50";
            } else {
                btnSdgs.className = "px-6 py-3 text-sm font-medium border rounded-l-lg focus:z-10 focus:ring-2 transition-colors bg-white text-slate-700 border-slate-300 hover:bg-slate-50";
                btnInfo.className = "px-6 py-3 text-sm font-medium border rounded-r-lg focus:z-10 focus:ring-2 transition-colors bg-indigo-600 text-white border-indigo-600";
            }
            renderApp();
        };

        window.handleAdminLogin = (e) => {
            e.preventDefault();
            if (document.getElementById('admin-password').value === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                document.getElementById('admin-password').value = '';
                renderApp();
            } else alert('å¯†ç¢¼éŒ¯èª¤');
        };

        window.handleAdminLogout = () => { isAdminLoggedIn = false; renderApp(); };

        window.updatePreview = () => {
            const val = document.getElementById('input-video').value;
            const embed = window.getEmbedUrl(val);
            const container = document.getElementById('video-preview-container');
            const frame = document.getElementById('video-preview-frame');
            if (embed) { container.classList.remove('hidden'); frame.src = embed; document.getElementById('video-error-msg').classList.add('hidden'); }
            else { container.classList.add('hidden'); frame.src = ''; if(val.length>0) document.getElementById('video-error-msg').classList.remove('hidden'); }
        };

        window.handleUpload = async (e) => {
            e.preventDefault();
            if (!db) return alert("è³‡æ–™åº«æœªé€£ç·š");
            
            const btn = document.getElementById('btn-submit');
            const originalText = btn.innerHTML;
            btn.innerHTML = `è™•ç†ä¸­...`;
            btn.disabled = true;
            log("é–‹å§‹ä¸Šå‚³è³‡æ–™...", 'info');

            const selectedCourseType = document.querySelector('input[name="courseType"]:checked').value;
            const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("è³‡æ–™åº«å¯«å…¥é€¾æ™‚ (Timeout)ã€‚è«‹æª¢æŸ¥ Rules æ˜¯å¦è¨­ç‚ºå…¬é–‹ã€‚")), 5000));

            try {
                const data = {
                    title: document.getElementById('input-title').value,
                    studentName: document.getElementById('input-student').value,
                    description: document.getElementById('input-desc').value,
                    videoUrl: document.getElementById('input-video').value,
                    slidesUrl: document.getElementById('input-slides').value,
                    courseType: selectedCourseType,
                    createdAt: serverTimestamp()
                };
                
                await Promise.race([addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'student_projects'), data), timeoutPromise]);
                
                log("âœ… ä¸Šå‚³æˆåŠŸï¼", 'success');
                document.getElementById('input-title').value = '';
                document.getElementById('input-student').value = '';
                document.getElementById('input-desc').value = '';
                document.getElementById('input-video').value = '';
                document.getElementById('input-slides').value = '';
                updatePreview();
                alert('ç™¼å¸ƒæˆåŠŸï¼');
                window.switchTab('gallery');
            } catch (err) {
                log(`âŒ ä¸Šå‚³å¤±æ•—: ${err.message}`, 'error');
                alert('ä¸Šå‚³å¤±æ•—ï¼š' + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        window.handleDelete = async (id) => {
            if (!db) return;
            if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                try {
                    log(`å˜—è©¦åˆªé™¤æ–‡ä»¶: ${id}`, 'info');
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'student_projects', id));
                    log("âœ… åˆªé™¤æˆåŠŸ", 'success');
                } catch(e) {
                    log(`âŒ åˆªé™¤å¤±æ•—: ${e.message}`, 'error');
                    alert('åˆªé™¤å¤±æ•—');
                }
            }
        };

        window.openModal = (id, type) => {
            const project = currentProjects.find(p => p.id === id);
            if (!project) return;
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            
            overlay.classList.remove('hidden');
            setTimeout(() => { overlay.classList.remove('opacity-0'); content.classList.remove('scale-95'); }, 10);
            
            document.getElementById('modal-title').innerHTML = project.title;
            document.getElementById('modal-author').textContent = `ä½œè€…ï¼š${project.studentName}`;
            document.getElementById('modal-desc').textContent = project.description || '';
            const bodyEl = document.getElementById('modal-body');

            if (type === 'video') {
                const embed = window.getEmbedUrl(project.videoUrl);
                bodyEl.innerHTML = `<div class="w-full h-full bg-black flex flex-col"><iframe src="${embed}" class="w-full flex-1" frameborder="0" allowfullscreen></iframe></div>`;
            } else {
                let slideUrl = project.slidesUrl;
                if (slideUrl && slideUrl.includes('canva.com') && !slideUrl.includes('embed')) slideUrl = slideUrl.split('?')[0] + '?embed';
                bodyEl.innerHTML = `<div class="w-full h-full bg-slate-100 flex flex-col"><iframe src="${slideUrl}" class="w-full flex-1 bg-white" frameborder="0" allowfullscreen></iframe></div>`;
            }
        };

        window.closeModal = () => {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.classList.add('opacity-0');
            content.classList.add('scale-95');
            setTimeout(() => { overlay.classList.add('hidden'); document.getElementById('modal-body').innerHTML = ''; }, 300);
        };

        function renderApp() {
            const filtered = currentProjects.filter(p => p.courseType === currentFilter);
            const grid = document.getElementById('gallery-grid');
            const empty = document.getElementById('gallery-empty');
            
            if (!db) return; // Wait for init

            if (filtered.length === 0) {
                grid.classList.add('hidden');
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                grid.classList.remove('hidden');
                grid.innerHTML = filtered.map(p => `
                    <div class="group bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow overflow-hidden flex flex-col h-full">
                        <div class="h-32 p-6 flex flex-col justify-center items-center text-center ${p.courseType === 'sdgs' ? 'bg-gradient-to-br from-green-50 to-emerald-100' : 'bg-gradient-to-br from-blue-50 to-indigo-100'}">
                            <h3 class="text-lg font-bold text-slate-800 line-clamp-2">${escapeHtml(p.title)}</h3>
                            <span class="mt-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-white/60 text-slate-600"><i data-lucide="user" class="w-3 h-3 mr-1"></i> ${escapeHtml(p.studentName)}</span>
                        </div>
                        <div class="p-6 flex-1 flex flex-col">
                            <p class="text-slate-600 text-sm mb-6 flex-1 line-clamp-3">${escapeHtml(p.description || "ç„¡å°ˆæ¡ˆæè¿°...")}</p>
                            <div class="grid grid-cols-2 gap-3 mt-auto">
                                <button onclick="openModal('${p.id}', 'video')" ${!p.videoUrl ? 'disabled' : ''} class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${p.videoUrl ? 'bg-red-50 text-red-700 hover:bg-red-100' : 'bg-slate-100 text-slate-400 cursor-not-allowed'}"><i data-lucide="monitor-play" class="w-4 h-4"></i> è§€çœ‹å½±ç‰‡</button>
                                <button onclick="openModal('${p.id}', 'slides')" ${!p.slidesUrl ? 'disabled' : ''} class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${p.slidesUrl ? 'bg-amber-50 text-amber-700 hover:bg-amber-100' : 'bg-slate-100 text-slate-400 cursor-not-allowed'}"><i data-lucide="presentation" class="w-4 h-4"></i> é–±è®€ç°¡å ±</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            // Update Admin List
            const adminList = document.getElementById('admin-list');
            const adminEmpty = document.getElementById('admin-empty');
            if (currentProjects.length === 0) {
                adminList.innerHTML = '';
                adminEmpty.classList.remove('hidden');
            } else {
                adminEmpty.classList.add('hidden');
                adminList.innerHTML = currentProjects.map(p => `
                    <li class="p-4 flex items-center justify-between hover:bg-slate-50 transition-colors">
                        <div class="flex-1 min-w-0 pr-4">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold ${p.courseType === 'sdgs' ? 'bg-green-100 text-green-700' : 'bg-indigo-100 text-indigo-700'}">${p.courseType === 'sdgs' ? 'SDGs' : 'è³‡è¨Š'}</span>
                                <p class="text-sm font-medium text-slate-900 truncate">${escapeHtml(p.title)}</p>
                            </div>
                            <p class="text-xs text-slate-500">${escapeHtml(p.studentName)}</p>
                        </div>
                        <button onclick="handleDelete('${p.id}')" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors flex items-center gap-1 text-xs font-medium"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </li>
                `).join('');
            }
            lucide.createIcons();
        }

        // --- Init ---
        try {
            log("åˆå§‹åŒ– Firebase...", 'info');
            const app = initializeApp(manualFirebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            log("Firebase åˆå§‹åŒ–å®Œæˆ", 'success');

            log("å˜—è©¦åŒ¿åç™»å…¥...", 'info');
            signInAnonymously(auth).then(() => {
                log("âœ… åŒ¿åç™»å…¥æˆåŠŸ", 'success');
            }).catch(e => {
                log(`âŒ ç™»å…¥å¤±æ•—: ${e.message}`, 'error');
            });

            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    log(`ä½¿ç”¨è€…å·²å°±ç·’ (UID: ${user.uid.substring(0,5)}...)`, 'info');
                    log(`é–‹å§‹ç›£è½è³‡æ–™è·¯å¾‘: /artifacts/${appId}/public/data/student_projects`, 'info');
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'student_projects'));
                    onSnapshot(q, (snapshot) => {
                        const loaded = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        loaded.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                        currentProjects = loaded;
                        document.getElementById('gallery-loader').classList.add('hidden');
                        document.getElementById('gallery-error').classList.add('hidden');
                        
                        if (loaded.length === 0) {
                            log("âœ… è®€å–æˆåŠŸï¼šç›®å‰è³‡æ–™åº«æ˜¯ç©ºçš„ (0 ç­†è³‡æ–™)", 'info');
                        } else {
                            log(`âœ… è®€å–æˆåŠŸï¼šå·²è¼‰å…¥ ${loaded.length} ç­†è³‡æ–™`, 'success');
                        }
                        renderApp();
                    }, (err) => {
                        console.error(err);
                        document.getElementById('gallery-loader').classList.add('hidden');
                        document.getElementById('gallery-error').classList.remove('hidden');
                        document.getElementById('gallery-error-msg').textContent = `${err.message} (Code: ${err.code})`;
                        log(`âŒ è®€å–å¤±æ•—: ${err.code} - è«‹æª¢æŸ¥ Rules æ¬Šé™`, 'error');
                    });
                }
            });
        } catch (e) {
            log(`âŒ ç³»çµ±éŒ¯èª¤: ${e.message}`, 'error');
            document.getElementById('gallery-loader').innerHTML = `<p class="text-red-500">åˆå§‹åŒ–å¤±æ•—ï¼š${e.message}</p>`;
        }

        lucide.createIcons();
    </script>
</body>
</html>