<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰èªè¨ˆç•«æˆæœå±•</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40 border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg text-white">
                    <i data-lucide="school" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-900 tracking-tight">ä¸‰èªè¨ˆç•«æˆæœå±•</h1>
                    <p class="text-xs text-slate-500 font-medium">SDGsç§‘æŠ€å‰µä½œ x è³‡è¨Šå°ˆé¡Œ (é›²ç«¯é€£ç·šç‰ˆ)</p>
                </div>
            </div>
            
            <nav class="flex space-x-1 bg-slate-100 p-1 rounded-lg">
                <button onclick="switchTab('gallery')" id="btn-tab-gallery" class="px-4 py-2 text-sm font-medium rounded-md transition-all bg-white text-blue-600 shadow-sm flex items-center gap-2">
                    <i data-lucide="layout" class="w-4 h-4"></i> æˆæœå±•ç¤º
                </button>
                <button onclick="switchTab('admin')" id="btn-tab-admin" class="px-4 py-2 text-sm font-medium rounded-md transition-all text-slate-600 hover:text-slate-900 flex items-center gap-2">
                    <i data-lucide="upload" class="w-4 h-4"></i> è³‡æ–™ä¸Šå‚³
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-1 w-full">
        
        <!-- Filter Buttons -->
        <div class="mb-8 flex justify-center">
            <div class="inline-flex rounded-md shadow-sm" role="group">
                <button type="button" onclick="setFilter('sdgs')" id="btn-filter-sdgs" class="px-6 py-3 text-sm font-medium border rounded-l-lg focus:z-10 focus:ring-2 transition-colors bg-blue-600 text-white border-blue-600">
                    ğŸŒ± SDGs ç§‘æŠ€å‰µä½œèª²
                </button>
                <button type="button" onclick="setFilter('info')" id="btn-filter-info" class="px-6 py-3 text-sm font-medium border rounded-r-lg focus:z-10 focus:ring-2 transition-colors bg-white text-slate-700 border-slate-300 hover:bg-slate-50">
                    ğŸ’» è³‡è¨Šå°ˆé¡Œèª²
                </button>
            </div>
        </div>

        <!-- Gallery View -->
        <div id="view-gallery" class="block">
            <div id="gallery-loader" class="flex flex-col items-center justify-center h-64 text-slate-400">
                <i data-lucide="loader-2" class="animate-spin w-8 h-8 text-blue-600 mb-4"></i>
                <p>æ­£åœ¨é€£ç·šè‡³è³‡æ–™åº«...</p>
            </div>
            <div id="gallery-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                <!-- Project cards will be injected here -->
            </div>
            <div id="gallery-empty" class="hidden text-center py-20 bg-white rounded-2xl border-2 border-dashed border-slate-200">
                <i data-lucide="school" class="mx-auto h-12 w-12 text-slate-300"></i>
                <h3 class="mt-2 text-sm font-semibold text-slate-900">ç›®å‰å°šç„¡æˆæœ</h3>
                <p class="mt-1 text-sm text-slate-500">è«‹åˆ‡æ›è‡³ã€Œè³‡æ–™ä¸Šå‚³ã€é é¢æ–°å¢å­¸ç”Ÿä½œå“ã€‚</p>
            </div>
        </div>

        <!-- Admin View -->
        <div id="view-admin" class="hidden">
            <!-- Login State -->
            <div id="admin-login" class="flex flex-col items-center justify-center py-20 bg-white rounded-xl shadow-sm border border-slate-200 max-w-md mx-auto">
                <div class="bg-slate-100 p-4 rounded-full mb-4">
                    <i data-lucide="lock" class="w-10 h-10 text-slate-400"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">ç®¡ç†å“¡æ¬Šé™é–å®š</h3>
                <p class="text-slate-500 mb-6 text-sm">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥é€²è¡Œè³‡æ–™ä¸Šå‚³æˆ–åˆªé™¤ã€‚</p>
                <form onsubmit="handleAdminLogin(event)" class="flex gap-2 w-full px-8">
                    <input type="password" id="admin-password" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="è¼¸å…¥å¯†ç¢¼..." autofocus>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 text-sm">è§£é–</button>
                </form>
            </div>

            <!-- Dashboard State -->
            <div id="admin-dashboard" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Form -->
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 sticky top-24">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                                <i data-lucide="plus" class="text-blue-600 w-5 h-5"></i>
                                æ–°å¢ <span id="admin-course-type-text">SDGs</span> ä½œå“
                            </h3>
                            <button onclick="handleAdminLogout()" class="text-xs text-slate-400 hover:text-slate-600 flex items-center gap-1">
                                <i data-lucide="log-out" class="w-3 h-3"></i> ç™»å‡º
                            </button>
                        </div>
                        
                        <form onsubmit="handleUpload(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">ä½œå“æ¨™é¡Œ *</label>
                                <input required type="text" id="input-title" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚ï¼šæ™ºæ…§åƒåœ¾æ¡¶è¨­è¨ˆ">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">å­¸ç”Ÿå§“å/çµ„å“¡ *</label>
                                <input required type="text" id="input-student" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜ã€æå°è¯">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">ä½œå“ç°¡ä»‹</label>
                                <textarea rows="3" id="input-desc" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="è«‹ç°¡è¿°å‰µä½œç†å¿µ..."></textarea>
                            </div>

                            <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 space-y-4">
                                <p class="text-xs text-slate-500 font-bold uppercase tracking-wider">è³‡æºè¨­å®š</p>
                                
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1 flex items-center gap-1">
                                        <i data-lucide="youtube" class="w-3 h-3"></i> å½±ç‰‡é€£çµ (URL æˆ– åµŒå…¥ä»£ç¢¼)
                                    </label>
                                    <input type="text" id="input-video" oninput="updatePreview()" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-1 focus:ring-blue-500 font-mono" placeholder="è²¼ä¸Š YouTube ç¶²å€ æˆ– <iframe...> åŸå§‹ç¢¼">
                                    <div id="video-preview-container" class="mt-3 bg-black rounded-lg overflow-hidden aspect-video relative hidden">
                                        <iframe id="video-preview-frame" class="w-full h-full" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin"></iframe>
                                        <div class="absolute top-2 right-2 bg-black/70 text-white text-[10px] px-2 py-1 rounded pointer-events-none">å³æ™‚é è¦½</div>
                                    </div>
                                    <p id="video-error-msg" class="hidden mt-2 text-[10px] text-red-500 flex items-center gap-1">
                                        <i data-lucide="alert-triangle" class="w-3 h-3"></i> ç„¡æ³•è­˜åˆ¥å½±ç‰‡ IDï¼Œè«‹æª¢æŸ¥å…§å®¹
                                    </p>
                                </div>

                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-2 flex items-center gap-1">
                                        <i data-lucide="file-text" class="w-3 h-3"></i> ç°¡å ±é€£çµ (Google/Canva)
                                    </label>
                                    <input type="url" id="input-slides" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-1 focus:ring-blue-500" placeholder="Google Slides / Canva é€£çµ">
                                    <p class="text-[10px] text-slate-400 mt-1">* Canva è«‹ä½¿ç”¨ã€Œåˆ†äº«ã€&gt;ã€ŒåµŒå…¥ã€é€£çµæ•ˆæœæœ€ä½³</p>
                                </div>
                            </div>

                            <button type="submit" id="btn-submit" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-medium hover:bg-blue-700 transition-colors flex justify-center items-center gap-2">
                                <i data-lucide="check-circle-2" class="w-4 h-4"></i> ç¢ºèªç™¼å¸ƒ
                            </button>
                        </form>
                    </div>
                </div>

                <!-- List -->
                <div class="lg:col-span-2">
                    <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                        <i data-lucide="unlock" class="text-emerald-600 w-4 h-4"></i>
                        ç®¡ç†å“¡æ¨¡å¼ï¼šå·²ä¸Šå‚³ä½œå“
                    </h3>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <ul id="admin-list" class="divide-y divide-slate-100">
                            <!-- List items injected here -->
                        </ul>
                        <div id="admin-empty" class="p-8 text-center text-slate-500 hidden">æ­¤åˆ†é¡å°šæœªä¸Šå‚³è³‡æ–™</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div id="modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden flex flex-col h-[90vh] scale-95 transition-transform duration-300" id="modal-content">
            <div class="p-4 border-b border-slate-100 flex items-center justify-between bg-white sticky top-0 z-10">
                <div>
                    <h2 id="modal-title" class="text-lg font-bold text-slate-900 flex items-center gap-2">
                        <!-- Icon + Title -->
                    </h2>
                    <p id="modal-author" class="text-sm text-slate-500"></p>
                </div>
                <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-500 hover:text-slate-900">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="modal-body" class="flex-1 bg-slate-100 relative w-full overflow-hidden flex flex-col">
                <!-- Iframe or Content -->
            </div>

            <div id="modal-desc" class="p-4 bg-slate-50 text-sm text-slate-600 border-t border-slate-200 shrink-0">
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        // ã€é‡è¦ï¼šè«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ Firebase Configã€‘
        // è«‹å°‡ä¸‹æ–¹å¤§æ‹¬è™Ÿå…§çš„å…§å®¹æ›¿æ›ç‚ºæ‚¨å¾ Firebase Console è¤‡è£½çš„ç¨‹å¼ç¢¼
        // =================================================================
     const firebaseConfig = {
  apiKey: "AIzaSyC1Z2nRBGkPwJTM1dZFvCyLqji50RcHwbo",
  authDomain: "education-e16d3.firebaseapp.com",
  projectId: "education-e16d3",
  storageBucket: "education-e16d3.firebasestorage.app",
  messagingSenderId: "748864808320",
  appId: "1:748864808320:web:459ab4958dc61385c3cd65",
  measurementId: "G-TX9CJ5BJ6E"
};
        // =================================================================

        // --- 1. Global State Definition (Before Init) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'school-project-default';
        const ADMIN_PASSWORD = "mdjhmdjh";
        
        let db = null;
        let auth = null;
        let currentUser = null;
        let currentProjects = [];
        let currentFilter = 'sdgs'; // 'sdgs' or 'info'
        let currentTab = 'gallery';
        let isAdminLoggedIn = false;

        // --- 2. Define UI Functions FIRST (Attached to Window) ---
        
        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Helper: URL Parser
        window.getEmbedUrl = (inputString) => {
            if (!inputString) return '';
            let cleanUrl = inputString.trim();
            
            if (cleanUrl.includes('<iframe')) {
                const srcMatch = cleanUrl.match(/src\s*=\s*["']([^"']+)["']/);
                if (srcMatch && srcMatch[1]) {
                    cleanUrl = srcMatch[1];
                } else {
                    return ''; 
                }
            }

            try {
                const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=|live\/|shorts\/)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = cleanUrl.match(youtubeRegex);
                if (match && match[1]) {
                    return `https://www.youtube.com/embed/${match[1]}?rel=0&modestbranding=1&playsinline=1`;
                }
                if (cleanUrl.includes('drive.google.com')) {
                    return cleanUrl.replace(/\/view.*$/, '/preview').replace(/\/edit.*$/, '/preview');
                }
                if (cleanUrl.includes('vimeo.com')) {
                    const parts = cleanUrl.split('/');
                    const possibleId = parts[parts.length-1].split('?')[0];
                    if (!isNaN(possibleId)) return `https://player.vimeo.com/video/${possibleId}`;
                }
                if (cleanUrl.startsWith('<')) return ''; 
                return cleanUrl;
            } catch (e) {
                return '';
            }
        };

        // Tab Switching
        window.switchTab = (tab) => {
            currentTab = tab;
            const btnGallery = document.getElementById('btn-tab-gallery');
            const btnAdmin = document.getElementById('btn-tab-admin');
            
            if (tab === 'gallery') {
                btnGallery.className = "px-4 py-2 text-sm font-medium rounded-md transition-all bg-white text-blue-600 shadow-sm flex items-center gap-2";
                btnAdmin.className = "px-4 py-2 text-sm font-medium rounded-md transition-all text-slate-600 hover:text-slate-900 flex items-center gap-2";
                document.getElementById('view-gallery').classList.remove('hidden');
                document.getElementById('view-admin').classList.add('hidden');
            } else {
                btnGallery.className = "px-4 py-2 text-sm font-medium rounded-md transition-all text-slate-600 hover:text-slate-900 flex items-center gap-2";
                btnAdmin.className = "px-4 py-2 text-sm font-medium rounded-md transition-all bg-white text-blue-600 shadow-sm flex items-center gap-2";
                document.getElementById('view-gallery').classList.add('hidden');
                document.getElementById('view-admin').classList.remove('hidden');
            }
            renderApp();
        };

        // Filter Switching
        window.setFilter = (filter) => {
            currentFilter = filter;
            const btnSdgs = document.getElementById('btn-filter-sdgs');
            const btnInfo = document.getElementById('btn-filter-info');
            
            if (filter === 'sdgs') {
                btnSdgs.className = "px-6 py-3 text-sm font-medium border rounded-l-lg focus:z-10 focus:ring-2 transition-colors bg-blue-600 text-white border-blue-600";
                btnInfo.className = "px-6 py-3 text-sm font-medium border rounded-r-lg focus:z-10 focus:ring-2 transition-colors bg-white text-slate-700 border-slate-300 hover:bg-slate-50";
            } else {
                btnSdgs.className = "px-6 py-3 text-sm font-medium border rounded-l-lg focus:z-10 focus:ring-2 transition-colors bg-white text-slate-700 border-slate-300 hover:bg-slate-50";
                btnInfo.className = "px-6 py-3 text-sm font-medium border rounded-r-lg focus:z-10 focus:ring-2 transition-colors bg-indigo-600 text-white border-indigo-600";
            }
            renderApp();
        };

        // Admin Functions
        window.handleAdminLogin = (e) => {
            e.preventDefault();
            const pwd = document.getElementById('admin-password').value;
            if (pwd === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                document.getElementById('admin-password').value = '';
                renderApp();
            } else {
                alert('å¯†ç¢¼éŒ¯èª¤');
            }
        };

        window.handleAdminLogout = () => {
            isAdminLoggedIn = false;
            renderApp();
        };

        window.updatePreview = () => {
            const val = document.getElementById('input-video').value;
            const embed = window.getEmbedUrl(val);
            const container = document.getElementById('video-preview-container');
            const frame = document.getElementById('video-preview-frame');
            const errorMsg = document.getElementById('video-error-msg');
            
            if (embed) {
                container.classList.remove('hidden');
                frame.src = embed;
                errorMsg.classList.add('hidden');
            } else {
                container.classList.add('hidden');
                frame.src = '';
                if (val.length > 0) errorMsg.classList.remove('hidden');
                else errorMsg.classList.add('hidden');
            }
        };

        window.handleUpload = async (e) => {
            e.preventDefault();
            if (!db) {
                alert("è³‡æ–™åº«å°šæœªé€£ç·šã€‚\n\nè«‹æª¢æŸ¥ HTML ç¨‹å¼ç¢¼ä¸­çš„ `manualFirebaseConfig` æ˜¯å¦å·²å¡«å…¥æ­£ç¢ºçš„ Firebase è¨­å®šã€‚\n(æ‚¨ç›®å‰å¯èƒ½åœ¨ GitHub Pages ä¸Šé‹è¡Œï¼Œéœ€è¦æ‰‹å‹•å¡«å…¥ Key)");
                return;
            }
            const btn = document.getElementById('btn-submit');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> è™•ç†ä¸­...`;
            lucide.createIcons();
            btn.disabled = true;

            try {
                const data = {
                    title: document.getElementById('input-title').value,
                    studentName: document.getElementById('input-student').value,
                    description: document.getElementById('input-desc').value,
                    videoUrl: document.getElementById('input-video').value,
                    slidesUrl: document.getElementById('input-slides').value,
                    courseType: currentFilter,
                    createdAt: serverTimestamp()
                };

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'student_projects'), data);
                
                e.target.reset();
                updatePreview();
                alert('ç™¼å¸ƒæˆåŠŸï¼');
            } catch (err) {
                alert('ä¸Šå‚³å¤±æ•—: ' + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                lucide.createIcons();
            }
        };

        window.handleDelete = async (id) => {
            if (!db) return;
            if (confirm('ç¢ºå®šè¦åˆªé™¤ï¼Ÿ')) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'student_projects', id));
                } catch(e) {
                    alert('åˆªé™¤å¤±æ•—');
                }
            }
        };

        // Modal Functions
        window.openModal = (id, type) => {
            const project = currentProjects.find(p => p.id === id);
            if (!project) return;
            
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            const titleEl = document.getElementById('modal-title');
            const authorEl = document.getElementById('modal-author');
            const bodyEl = document.getElementById('modal-body');
            const descEl = document.getElementById('modal-desc');

            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
                content.classList.remove('scale-95');
            }, 10);

            titleEl.innerHTML = type === 'video' 
                ? `<i data-lucide="monitor-play" class="text-red-600 w-5 h-5"></i> ${escapeHtml(project.title)}` 
                : `<i data-lucide="presentation" class="text-amber-600 w-5 h-5"></i> ${escapeHtml(project.title)}`;
            authorEl.textContent = `ä½œè€…ï¼š${project.studentName}`;
            descEl.textContent = project.description || '';

            if (type === 'video') {
                const embed = window.getEmbedUrl(project.videoUrl);
                bodyEl.innerHTML = `
                    <div class="w-full h-full bg-black flex flex-col">
                        <iframe src="${embed}" class="w-full flex-1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                        <div class="bg-slate-900 border-t border-slate-700 text-white p-4 text-center text-sm flex flex-col items-center gap-2">
                             <a href="${project.videoUrl}" target="_blank" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full transition-colors flex items-center gap-2 font-bold text-xs">
                                <i data-lucide="external-link" class="w-4 h-4"></i> å‰å¾€ YouTube è§€çœ‹
                            </a>
                        </div>
                    </div>
                `;
            } else {
                let slideUrl = project.slidesUrl;
                if (slideUrl && slideUrl.includes('canva.com') && !slideUrl.includes('embed')) {
                    slideUrl = slideUrl.split('?')[0] + '?embed';
                }
                bodyEl.innerHTML = `
                    <div class="w-full h-full bg-slate-100 flex flex-col">
                        <iframe src="${slideUrl}" class="w-full flex-1 bg-white" frameborder="0" allowfullscreen></iframe>
                        <div class="bg-slate-200 text-slate-600 p-2 text-center text-xs flex justify-center gap-2">
                            <a href="${project.slidesUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 underline flex items-center gap-1">
                                <i data-lucide="external-link" class="w-3 h-3"></i> åœ¨æ–°è¦–çª—é–‹å•Ÿ
                            </a>
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        };

        window.closeModal = () => {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            
            overlay.classList.add('opacity-0');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                overlay.classList.add('hidden');
                document.getElementById('modal-body').innerHTML = ''; 
            }, 300);
        };

        // Main Render Function
        function renderApp() {
            const filtered = currentProjects.filter(p => p.courseType === currentFilter);
            
            // 1. Render Gallery
            const galleryLoader = document.getElementById('gallery-loader');
            const galleryGrid = document.getElementById('gallery-grid');
            const galleryEmpty = document.getElementById('gallery-empty');
            
            if (currentProjects.length > 0 || !currentUser) {
                galleryLoader.classList.add('hidden');
            }

            if (filtered.length === 0) {
                galleryGrid.classList.add('hidden');
                if (!galleryLoader.classList.contains('hidden')) {
                     // still loading
                } else {
                    galleryEmpty.classList.remove('hidden');
                }
            } else {
                galleryEmpty.classList.add('hidden');
                galleryGrid.classList.remove('hidden');
                galleryGrid.innerHTML = filtered.map(p => `
                    <div class="group bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow overflow-hidden flex flex-col h-full">
                        <div class="h-32 p-6 flex flex-col justify-center items-center text-center ${p.courseType === 'sdgs' ? 'bg-gradient-to-br from-green-50 to-emerald-100' : 'bg-gradient-to-br from-blue-50 to-indigo-100'}">
                            <h3 class="text-lg font-bold text-slate-800 line-clamp-2">${escapeHtml(p.title)}</h3>
                            <span class="mt-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-white/60 text-slate-600">
                                <i data-lucide="user" class="w-3 h-3 mr-1"></i> ${escapeHtml(p.studentName)}
                            </span>
                        </div>
                        <div class="p-6 flex-1 flex flex-col">
                            <p class="text-slate-600 text-sm mb-6 flex-1 line-clamp-3">${escapeHtml(p.description || "ç„¡å°ˆæ¡ˆæè¿°...")}</p>
                            <div class="grid grid-cols-2 gap-3 mt-auto">
                                <button onclick="openModal('${p.id}', 'video')" ${!p.videoUrl ? 'disabled' : ''} class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${p.videoUrl ? 'bg-red-50 text-red-700 hover:bg-red-100' : 'bg-slate-100 text-slate-400 cursor-not-allowed'}">
                                    <i data-lucide="monitor-play" class="w-4 h-4"></i> è§€çœ‹å½±ç‰‡
                                </button>
                                <button onclick="openModal('${p.id}', 'slides')" ${!p.slidesUrl ? 'disabled' : ''} class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${p.slidesUrl ? 'bg-amber-50 text-amber-700 hover:bg-amber-100' : 'bg-slate-100 text-slate-400 cursor-not-allowed'}">
                                    <i data-lucide="presentation" class="w-4 h-4"></i> é–±è®€ç°¡å ±
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // 2. Render Admin
            const adminLogin = document.getElementById('admin-login');
            const adminDash = document.getElementById('admin-dashboard');
            
            if (!isAdminLoggedIn) {
                adminLogin.classList.remove('hidden');
                adminDash.classList.add('hidden');
            } else {
                adminLogin.classList.add('hidden');
                adminDash.classList.remove('hidden');
                document.getElementById('admin-course-type-text').textContent = currentFilter === 'sdgs' ? 'SDGs' : 'è³‡è¨Šå°ˆé¡Œ';
                
                const adminList = document.getElementById('admin-list');
                const adminEmpty = document.getElementById('admin-empty');
                
                if (filtered.length === 0) {
                    adminList.innerHTML = '';
                    adminEmpty.classList.remove('hidden');
                } else {
                    adminEmpty.classList.add('hidden');
                    adminList.innerHTML = filtered.map(p => `
                        <li class="p-4 flex items-center justify-between hover:bg-slate-50 transition-colors">
                            <div class="flex-1 min-w-0 pr-4">
                                <p class="text-sm font-medium text-slate-900 truncate">${escapeHtml(p.title)}</p>
                                <p class="text-xs text-slate-500">${escapeHtml(p.studentName)}</p>
                                <div class="flex gap-2 mt-1">
                                    ${p.videoUrl ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">å½±ç‰‡ OK</span>' : ''}
                                    ${p.slidesUrl ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">ç°¡å ±(é€£çµ)</span>' : ''}
                                </div>
                            </div>
                            <button onclick="handleDelete('${p.id}')" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors flex items-center gap-1 text-xs font-medium">
                                <i data-lucide="trash-2" class="w-4 h-4"></i> åˆªé™¤
                            </button>
                        </li>
                    `).join('');
                }
            }
            lucide.createIcons();
        }

        // --- 3. Initialize Firebase Safely ---
        try {
            // Priority: Environment Variable > Manual Config > Empty
            let firebaseConfig = {};
            
            if (typeof __firebase_config !== 'undefined') {
                // Inside Canvas Environment
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                // Outside Canvas (GitHub Pages)
                // Check if manual config has been filled
                const isConfigEmpty = !manualFirebaseConfig.apiKey || manualFirebaseConfig.apiKey === "" || manualFirebaseConfig.apiKey === "æ‚¨çš„apiKey";
                
                if (isConfigEmpty) {
                    // Show instructional error on UI instead of just console
                    document.getElementById('gallery-loader').innerHTML = `
                        <div class="text-center p-6 max-w-lg mx-auto bg-red-50 rounded-xl border border-red-200">
                            <i data-lucide="alert-triangle" class="w-10 h-10 text-red-500 mx-auto mb-3"></i>
                            <p class="text-red-600 font-bold mb-2 text-lg">âš ï¸ å°šæœªè¨­å®šè³‡æ–™åº«é€£ç·š</p>
                            <p class="text-sm text-red-500 mb-4 leading-relaxed">æ­¤ç¶²é ç›®å‰é‹è¡Œæ–¼å¤–éƒ¨ç’°å¢ƒ (å¦‚ GitHub Pages)ï¼Œç„¡æ³•è‡ªå‹•å–å¾—è³‡æ–™åº«è¨­å®šã€‚<br>è«‹æ‰‹å‹•å¡«å…¥ Firebase API Keyã€‚</p>
                            <div class="bg-white p-3 rounded border border-red-100 text-left text-xs text-slate-500 font-mono">
                                1. ä½¿ç”¨è¨˜äº‹æœ¬é–‹å•Ÿæ­¤ html æª”æ¡ˆ<br>
                                2. æœå°‹ "manualFirebaseConfig"<br>
                                3. å¡«å…¥ Firebase Console ä¸­çš„è¨­å®šå€¼
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                    // We don't throw error here to allow code to run, but functionality will be limited
                } else {
                    firebaseConfig = manualFirebaseConfig;
                }
            }

            if (firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Auth
                async function initAuth() {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth Error:", error);
                    }
                }
                initAuth();

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        setupRealtimeListener();
                    } else {
                        document.getElementById('gallery-loader').classList.add('hidden');
                        document.getElementById('gallery-empty').classList.remove('hidden');
                    }
                });

                function setupRealtimeListener() {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'student_projects'));
                    onSnapshot(q, (snapshot) => {
                        const loaded = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        loaded.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                        currentProjects = loaded;
                        renderApp();
                    }, (err) => {
                        console.error("Data fetch error", err);
                        document.getElementById('gallery-loader').classList.add('hidden');
                    });
                }
            }

        } catch (e) {
            console.error("Firebase Initialization Failed:", e);
            if (!document.getElementById('gallery-loader').innerHTML.includes('å°šæœªè¨­å®šè³‡æ–™åº«é€£ç·š')) {
                 document.getElementById('gallery-loader').innerHTML = `<p class="text-red-500">åˆå§‹åŒ–å¤±æ•—ï¼š${e.message}</p>`;
            }
        }

        // Initial Icon Render
        lucide.createIcons();

    </script>
</body>
</html>